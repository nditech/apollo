{% extends "frontend/layout.html" %}
{%- from 'frontend/macros/quality_assurance_dashboard_filter.html' import render_filter_form -%}

{%- block toolbar %}
<div class="btn-toolbar d-none d-md-flex" role="toolbar">
{% if perms.export_submissions.can() %}
<a class="btn btn-secondary" href="{{ url_for('submissions.quality_assurance_list', form_id=form.id, export='observer', **request.args) }}">{{ _('Export') }}</a>
{% endif %}
</div>
{%- endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    {{ render_filter_form(form, filter_form, location) }}
  </div>
</div>

<div class="row" id="check_breakdown" data-checks='{{ check_data|tojson }}'>
  <check :check="check" v-for="check in checks"></check>
</div>

<template id="chart-component">
  <div class="col-md-6 mb-2 mt-4">
    <h5 class="text-center"><%= check.description %></h5>
    <div :id="htmlID"></div>
  </div>
</template>
{% endblock %}
{% block scripts %}
<script type="text/javascript" src="{{ url_for('static', filename='js/d3.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/dimple.v2.3.0.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/vue.min.js') }}"></script>
<script>
var check_data = JSON.parse(document.getElementById('check_breakdown').getAttribute('data-checks'));

Vue.component('check', {
  delimiters: [ '<%=', '%>' ],
  props: ['check'],
  computed: {
    htmlID: function () {
      return 'qa_' + this.check.name;
    }
  },
  mounted: function() {
    this.$nextTick(function (){
      var compSvg = dimple.newSvg('#' + this.htmlID, '100%', '250px');
      var chart = new dimple.chart(compSvg, this.check.counts);

      var x_axis = chart.addMeasureAxis('x', 'count');
      x_axis.tickFormat = 'd';
      x_axis.overrideMax = this.check.total;

      chart.setMargins(100, 50, 50, 50);
      chart.addCategoryAxis('y', 'label').addOrderRule([
        'OK', 'Verified', 'Flagged', 'Missing'
      ], true);

      chart.addSeries('label', dimple.plot.bar);
      chart.assignColor('OK', '#28a745');
      chart.assignColor('Verified', '#007bff');
      chart.assignColor('Flagged', '#dc3545');
      chart.assignColor('Missing', '#6c757d');

      chart.draw();
    });
  },
  template: '#chart-component'
});

var app = new Vue({
  el: '#check_breakdown',
  data: {checks: check_data}
});
</script>
<script type="text/javascript">
$(function () {
	$('#filter_reset').on('click', function() {
		var $form = $(this).parents('form').first();
		$form.find(':input').not('button').each(function() { $(this).val(''); })
		$form.submit();
	});
	$('select.select2-locations').select2(LocationOptions);
});
</script>
{% endblock %}
