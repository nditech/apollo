{% extends 'frontend/layout.html' -%}
{% from 'frontend/macros/submission_field_macros.html' import render_field %}
{% from 'frontend/macros/submission_components.html' import section_navigation, failed_qa_checks %}
{%- set form, siblings, master = submission.form, submission.siblings, submission.master %}


{%- block stylesheets %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-switch-button.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/slick.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/slick-theme.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/viewer.min.css') }}">
<style>
  .split {
    display: flex;
    flex-direction: row;
  }

  .gutter {
    background-color: #6c757d !important;
    background-color: transparent;
    background-repeat: no-repeat;
    background-position: 50%;
  }

  .gutter.gutter-horizontal {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
    cursor: col-resize;
  }

  .viewer-download, .viewer-delete {
    color: #fff;
    font-family: FontAwesome, serif;
    font-size: 0.75rem;
    line-height: 1.5rem;
    text-align: center;
  }

  .viewer-delete::before {
    content: "\f1f8";
  }

  .viewer-download::before {
    content: "\f019";
  }

  #viewer1 {
    height: 100%;
  }
</style>
{% endblock %}



{%- block content %}
<div>
<div id="lhs">
<form method="POST" enctype="multipart/form-data">
<input type="hidden" name="next" value="{% if request.environ.get('HTTP_REFERER') == request.url %}{{ url_for('submissions.submission_list', form_id=form.id) }}{% else %}{{ request.environ.get('HTTP_REFERER', url_for('submissions.submission_list', form_id=form.id)) }}{% endif %}" />
{{ submission_form.csrf_token() }}
{%- if form.form_type in ['CHECKLIST', 'SURVEY'] %}
{%- for f in sibling_forms -%}{{ f.csrf_token() }}{%- endfor -%}{{ master_form.csrf_token() }}
{%- endif %}

<div id="infocard" class="table-responsive sticky-top bg-white {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}">
  <table class="table table-bordered">
  {%- if submission.form.form_type == 'SURVEY' %}
  <tr>
    <th class="col-2">{{ _('Form ID') }}</th>
    <td><strong>{{ submission.serial_no }}</strong></td>
  </tr>
  {%- endif %}
  <tr class="important">
    <th class="col-2">{{ _('Participant') }}</th>
    <td>{% if submission.participant %}<strong>{{ submission.participant.name }}</strong> &mdash; <strong>{{ submission.participant.participant_id }}</strong>{%- if submission.participant.primary_phone %} ({{ submission.participant.primary_phone }}){%- endif %}
    <input type="hidden" name="{{ submission_form['participant'].name }}" value="{{ submission_form['participant'].data.id|default('__None', true) }}" />
    {%- else -%}{{ submission_form.participant(class_='select2-container span4 input-xlarge select2 select2-observers') }}{% endif %}</td>
    {%- if form.form_type == 'CHECKLIST' and not form.untrack_data_conflicts -%}
    {%- for sib in siblings -%}
    <td>{% if sib.participant %}<strong>{{ sib.participant.name }}</strong> &mdash; <strong>{{ sib.participant.participant_id }}</strong>{% if sib.participant.primary_phone %} ({{ sib.participant.primary_phone }}){% endif %}{% endif %}</td>
    {%- endfor -%}
    {%- endif -%}
  </tr>
  <tr>
    <th>{{ _('Last Contacted') }}</th>
    <td>{% if submission.participant.last_contacted %}<span class="tonow" data-timestamp="{{ submission.participant.last_contacted|timestamp }}">{{ submission.participant.last_contacted.strftime('%b %d, %Y %I:%M %p') }}</span>{% else %}{{ _('-') }}{% endif %}</td>
    {%- if form.form_type == 'CHECKLIST' and not form.untrack_data_conflicts -%}
    {%- for sib in siblings -%}
    <td>{% if sib.participant.last_contacted %}<span class="tonow" data-timestamp="{{ sib.participant.last_contacted|timestamp }}">{{ sib.participant.last_contacted.strftime('%b %d, %Y %I:%M %p') }}</span>{% else %}{{ _('-') }}{% endif %}</td>
    {%- endfor -%}
    {%- endif -%}
  </tr>
  <tr>
    <th>{{ _('Texted Phone') }}</th>
    <td>{% if submission.last_phone_number %}<strong>{{ submission.last_phone_number }}</strong> <a href="javascript:;" {%- if not perms.edit_participant.can() %} style="pointer-events:none"{% endif %} id="toggle_verification" data-participant="{{ submission.participant.id }}" data-phone="{{ submission.last_phone_number }}"><span id="toggle_verification_badge" class="badge badge-pill {% if submission.sender_verified %}badge-success{% else %}badge-warning{% endif %}">{% if submission.sender_verified %}{{ _('Verified') }}{% else %}{{ _('Unverified') }}{% endif %}</span></a> <div class="spinner-grow spinner-grow-sm inline-block invisible" id="toggle_verification_spinner" role="status"><span class="sr-only">Loading...</span></div>{% else %}{{ _('-') }}{% endif %}</td>
    {%- if form.form_type == 'CHECKLIST' and not form.untrack_data_conflicts -%}
    {%- for sib in siblings -%}
    <td>{% if sib.last_phone_number %}<strong>{{ sib.last_phone_number }}</strong> {% if sib.sender_verified %}<span id="phone_verification_status" class="badge badge-pill badge-success">{{ _('Verified') }}</span>{% else %}<span id="phone_verification_status" class="badge badge-pill badge-warning">{{ _('Unverified') }}</span>{% endif %}{% else %}{{ _('-') }}{% endif %}</td>
    {%- endfor -%}
    {%- endif -%}
  </tr>
  <tr>
    <th>{{ _('Other Phones') }}</th>
    <td>
      {% if submission.participant and submission.participant.other_phones %}{{ submission.participant.other_phones|join(', ') }}{% else %}{{ _('-') }}{% endif %}
    </td>
    {%- if form.form_type == 'CHECKLIST' and not form.untrack_data_conflicts -%}
    {%- for sib in siblings -%}
    <td>{% if sib.participant and sib.participant.other_phones %}{{ sib.participant.other_phones|join(', ') }}{% else %}{{ _('-') }}{% endif %}</td>
    {%- endfor -%}
    {%- endif -%}
  </tr>
  <tr>
    <th>{{ _('Role') }}</th>
    <td>{{ submission.participant.role|default(_('-'), true) }}</td>
    {%- if form.form_type == 'CHECKLIST' and not form.untrack_data_conflicts -%}
    {%- for sib in siblings -%}
    <td>{{ sib.participant.role }}</td>
    {%- endfor -%}
    {%- endif -%}
  </tr>
  {%- if form.form_type in ['CHECKLIST', 'SURVEY'] -%}
  {#- checklist #}
  <tr class="important">
    <th>{{ _('Location') }}</th>
    <td>
      {% for location_type, location_name in submission.location.make_path().items() %}
      {{ location_name }} &middot; <em>{{ location_type }}</em>{% if not loop.last %} / {% endif %}
      {% else %}
      {{ _('N/A') }}
      {% endfor %}
      <input type="hidden" name="{{ submission_form['location'].name }}" value="{{ submission.location.id|default('__None', true) }}" />
    </td>
    {%- if form.form_type == 'CHECKLIST' and not form.untrack_data_conflicts -%}
    {% for sib in siblings %}
    <td>
      {% for location_type, location_name in submission.location.make_path().items() %}
      {{ location_name }} &middot; <em>{{ location_type }}</em>{% if not loop.last %} / {% endif %}
      {% else %}
      {{ _('N/A') }}
      {% endfor %}
    </td>
    {% endfor %}
    {%- endif %}
  </tr>
  <tr>
    <th>{{ _('Supervisor') }}</th>
    <td>{% if submission.participant and submission.participant.supervisor %}<strong>{{ submission.participant.supervisor.name|default('<em>{}</em>'.format(_('N/A')), true) }}</strong>{%- if submission.participant.supervisor.primary_phone %} ({{ submission.participant.supervisor.primary_phone }}){%- endif -%}{% else %}{{ _('N/A') }}{% endif %}</td>
    {%- if form.form_type == 'CHECKLIST' and not form.untrack_data_conflicts -%}
    {%- for sib in siblings -%}
    <td>{% if sib.participant and sib.participant.supervisor %}<strong>{{ sib.participant.supervisor.name|default('<em>{}</em>'.format(_('N/A')), true) }}</strong>{%- if sib.participant.supervisor.primary_phone %} ({{ sib.participant.supervisor.primary_phone }}){%- endif -%}{% else %}{{ _('N/A') }}{% endif %}</td>
    {%- endfor -%}
    {%- endif %}
  </tr>
  {%- else -%}
  {#- critical incident #}
  <tr>
    <th>{{ _('Location') }}</th>
    <td>
      {% for location_type, location_name in submission.location.make_path().items() %}
      {{ location_name }} &middot; <em>{{ location_type }}</em>{% if not loop.last %} / {% endif %}
      {% else %}
      {{ _('N/A') }}
      {% endfor %}
      <input type="hidden" name="{{ submission_form['location'].name }}" value="{{ submission.location.id|default('__None', true) }}" />
    </td>
  </tr>
  {%- endif -%}
  </table>
</div>

{%- if form.form_type in ['CHECKLIST', 'SURVEY'] %}
{{ section_navigation(submission) }}

  {%- if failed_checks and submission.form.quality_checks_enabled and perms.view_quality_assurance.can() %}
  {{ failed_qa_checks(failed_checks) }}
  {%- endif %}
{%- endif %}

{%- if form.form_type in ['CHECKLIST', 'SURVEY'] %}
{%- set num_forms = ((sibling_forms|count) + (2 if master_form else 1)) -%}
{%- if master_form.errors or submission_form.errors %}
<div class="alert alert-danger alert-dismissible fade show mt-4 mb-0" role="alert">
  <h5 class="alert-heading">{{ _('Data Validation Errors') }}</h5>
  <p>{{ _('The data you entered are not valid. Please check the affected questions and correct them.') }}</p>
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div>
{%- endif %}

<div class="card-body tab-content px-0 {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}" id="tabbed-content">
  <div class="tab-pane fade show active" id="checklist-panel" role="tabpanel" aria-labelledby="checklist-tab">
    <div class="card bg-light mb-3">
      <div class="card-header py-0 px-0">
        <table class="table table-borderless mb-0">
          <tbody>
            <tr>
              <td class="align-middle">&nbsp;</td>
              <td class="col-2 align-middle text-center">
              {%- if perms.edit_both_submissions.can() %}
                <div class="custom-control custom-radio">
                  <input type="radio" id="{{ submission.id }}" name="submission_selection" class="custom-control-input obs1" value="obs"{% if not readonly %} checked="checked"{% else %} disabled="disabled"{% endif %}>
                  <label class="custom-control-label" for="{{ submission.id }}"><strong>{{ submission.participant.participant_id }}</strong></label>
                </div>
              {% else %}
                <span><strong>{{ submission.participant.participant_id }}</strong></span>
              {% endif %}
              </td>
              {%- if form.form_type == 'CHECKLIST' and not form.untrack_data_conflicts -%}
              {% for sibling in siblings -%}
              <td class="col-2 align-middle text-center">
                <span><strong>{{ sibling.participant.participant_id }}</strong></span>
              </td>
              {%- endfor %}
              <td class="col-2 align-middle text-center">
              {%- if perms.edit_both_submissions.can() %}
                <div class="custom-control custom-radio">
                  <input type="radio" id="{{ master.id }}" name="submission_selection" class="custom-control-input ps" value="ps"{% if readonly %} checked="checked"{% endif %}>
                  <label class="custom-control-label" for="{{ master.id }}"><strong>{{ _('Location') }}</strong></label>
                </div>
              {% else %}
                <span><strong>{{ _('Location') }}</strong></span>
              {% endif %}
              </td>
              {% endif %}
            </tr>
          </tbody>
        </table>
      </div>
      <div id="setup" class="card-body collapse show px-0 py-1">
        <table class="table table-borderless mb-0">
          <tbody>
            <tr>
              <td class="align-middle"><strong>{{ _('Signal') }}</strong></td>
              <td class="col-2 align-middle obs-on text-center">
                <label for="{{ submission_form.unreachable.id }}" class="sr-only">{{ submission_form.unreachable.label.text }}</label>
                {%- if readonly %}
                {{ submission_form.unreachable(**{'class_': 'tracked', 'data-toggle': 'switchbutton', 'data-width': '80', 'data-onlabel': _('No Signal'), 'data-onstyle': 'danger', 'data-offlabel': _('Signal'), 'data-offstyle': 'primary', 'data-size': 'sm', 'disabled': 'disabled'}) }}
                {%- else %}
                {{ submission_form.unreachable(**{'class_': 'tracked', 'data-toggle': 'switchbutton', 'data-width': '80', 'data-onlabel': _('No Signal'), 'data-onstyle': 'danger', 'data-offlabel': _('Signal'), 'data-offstyle': 'primary', 'data-size': 'sm'}) }}
                {%- endif %}
              </td>
              {%- if form.form_type == 'CHECKLIST' and not form.untrack_data_conflicts -%}
              {%- for sibling_form in sibling_forms %}
              <td class="col-2 align-middle">
                &nbsp;
              </td>
              {% endfor %}
              <td class="col-2 align-middle">&nbsp;</td>
              {%- endif %}
            </tr>
            {% if perms.edit_submission_quarantine_status.can() %}
            <tr>
              <td class="align-middle"><strong>{{ _('Quarantine Status') }}</strong></td>
              <td class="col-2 align-middle obs-on">
                <label for="{{ submission_form.quarantine_status.id }}" class="sr-only">{{ submission_form.quarantine_status.label.text }}</label>
                {%- if readonly %}
                {{ render_field(submission_form.quarantine_status, 'select', klass_='form-control tracked text-monospace', perms=perms, disabled='disabled') }}
                {%- else %}
                {{ render_field(submission_form.quarantine_status, 'select', klass_='form-control tracked text-monospace', perms=perms) }}
                {%- endif %}
              </td>
              {%- if form.form_type == 'CHECKLIST' and not form.untrack_data_conflicts -%}
              {%- for sibling_form in sibling_forms %}
              <td class="col-2 align-middle">
                <label for="{{ sibling_form.quarantine_status.id }}" class="sr-only">{{ sibling_form.quarantine_status.label.text }}</label>
                {{ render_field(sibling_form.quarantine_status, 'select', klass_='form-control tracked text-monospace', perms=perms, disabled='disabled') }}
              </td>
              {% endfor %}
              <td class="col-2 align-middle ps-on">
                <label for="{{ master_form.quarantine_status.id }}" class="sr-only">{{ master_form.quarantine_status.label.text }}</label>
                {%- if readonly %}
                {{ render_field(master_form.quarantine_status, 'select', klass_='form-control tracked text-monospace', perms=perms) }}
                {%- else %}
                {{ render_field(master_form.quarantine_status, 'select', klass_='form-control tracked text-monospace', perms=perms, disabled='disabled') }}
                {%- endif %}
              </td>
              {%- endif %}
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    {% for group in form.data.groups %}
    {% set ns = namespace(has_form_error=false, has_qa_error=false) %}
    <div class="card bg-light {%- if not loop.last %} mb-3{% endif %} {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}">
      <div class="card-header d-flex justify-content-between align-items-center" data-toggle="collapse" data-target="#grp{{ loop.index }}" aria-expanded="{% if submission.completion(group.name) == 'Complete' and not ns.has_form_error and not ns.has_qa_error %}false{% else %}true{% endif %}" aria-controls="grp{{ loop.index }}">
        <h5 class="mb-0">{{ group.name }}</h5>
      </div>
      {# check for data validation or quality assurance errors #}
      {%- for field in group.fields %}
      {%- if submission_form[field.tag].errors %}{% set ns.has_form_error = true %}{% endif %}
      {%- if field.tag in failed_check_tags and submission.form.quality_checks_enabled -%}{% set ns.has_qa_error = true %}{% endif %}
      {%- endfor %}
      <div id="grp{{ loop.index }}" class="card-body {% if submission.completion(group.name) == 'Complete' and not ns.has_form_error and not ns.has_qa_error %} collapse{% else %} show{% endif %} py-0 px-0">
        <table class="table table-borderless mb-0 table-responsive">
          <tbody>
          {% for field in group.fields %}
            <tr {%- if field.tag in failed_check_tags and submission.form.quality_checks_enabled and field.tag not in submission.verified_fields %} class="bg-warning"{% endif %}>
              <td class="align-middle" style="width: 0.1%; white-space: nowrap;"><strong>{{ field.tag }}</strong></td>
              <td class="align-middle obs-on">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="mr-1">{{ field.description }}</div>
                  {% if field.tag in failed_check_tags and submission.form.quality_checks_enabled and perms.edit_submission_verification_status.can() %}
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" name="{{ submission_form.verified_fields.name }}" id="{{ submission_form.verified_fields.id }}_{{ field.tag }}" class="custom-control-input" value="{{ field.tag }}"{{ ' checked' if field.tag in submission.verified_fields else '' }}{{ ' disabled' if readonly else '' }}>
                    <label for="{{ submission_form.verified_fields.id }}_{{ field.tag }}" class="custom-control-label">{{ submission_form.verified_fields.label.text }}</label>
                  </div>
                  {% endif %}
                </div>
              </td>
              {% if readonly -%}
              <td class="col-2 align-middle obs-on" {% if field['type'] == 'image' %}colspan="{{ num_forms }}"{% endif %}><label for="{{ submission_form[field.tag].id }}" class="sr-only">{{ submission_form[field.tag].label.text }}</label>{{ render_field(submission_form[field.tag], field.type, description=field.description, klass_='form-control tracked text-monospace', perms=perms, disabled='disabled') }}</td>
              {%- else -%}
              {% if submission_form[field.tag].errors -%}
              <td class="col-2 align-middle obs-on" {% if field['type'] == 'image' %}colspan="{{ num_forms }}"{% endif %}><label for="{{ submission_form[field.tag].id }}" class="sr-only">{{ submission_form[field.tag].label.text }}</label>{{ render_field(submission_form[field.tag], field.type, description=field.description, klass_='form-control tracked text-monospace is-invalid', perms=perms) }}</td>
              {%- else -%}
              <td class="col-2 align-middle obs-on" {% if field['type'] == 'image' %}colspan="{{ num_forms }}"{% endif %}><label for="{{ submission_form[field.tag].id }}" class="sr-only">{{ submission_form[field.tag].label.text }}</label>{{ render_field(submission_form[field.tag], field.type, description=field.description, klass_='form-control tracked text-monospace', perms=perms) }}</td>
              {%- endif %}
              {%- endif %}
              {%- if form.form_type == 'CHECKLIST' and not form.untrack_data_conflicts and field['type'] != 'image' -%}
              {% for sibling_form in sibling_forms -%}
              <td class="col-2 align-middle"><label for="{{ sibling_form[field.tag].id }}" class="sr-only">{{ sibling_form[field.tag].label.text }}</label>{{ render_field(sibling_form[field.tag], field.type, klass_='form-control tracked text-monospace', perms=perms, disabled='disabled') }}</td>
              {% endfor %}
              {% if readonly -%}
              {% if master_form[field.tag].errors -%}
              <td class="col-2 align-middle ps-on"><label for="{{ master_form[field.tag].id }}" class="sr-only">{{ master_form[field.tag].label.text }}</label>{{ render_field(master_form[field.tag], field.type, klass_='form-control tracked text-monospace is-invalid', perms=perms) }}</td>
              {%- else -%}
              <td class="col-2 align-middle ps-on"><label for="{{ master_form[field.tag].id }}" class="sr-only">{{ master_form[field.tag].label.text }}</label>{{ render_field(master_form[field.tag], field.type, klass_='form-control tracked text-monospace border border-warning' if field.tag in master.overridden_fields else 'form-control tracked text-monospace', perms=perms) }}</td>
              {%- endif %}
              {%- else -%}
              <td class="col-2 align-middle ps-on"><label for="{{ master_form[field.tag].id }}" class="sr-only">{{ master_form[field.tag].label.text }}</label>{{ render_field(master_form[field.tag], field.type, klass_='form-control tracked text-monospace border border-warning' if field.tag in master.overridden_fields else 'form-control tracked text-monospace', perms=perms, disabled='disabled') }}</td>
              {%- endif %}
              {%- endif %}
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}

    {% if submission.image_attachments -%}
    <div class="card text-white bg-secondary mt-3" id="images">
      <div class="card-header">
        <h5 class="mb-0">{% trans %}Images{% endtrans %}</h5>
      </div>
      <div id="carousel-body-el" class="card-body">
        <div class='slick m-3'>
          {% for item in submission.get_image_data() -%}
          {% if item['attachment'] %}
          <div class="d-flex flex-column align-items-center justify-content-center mb-3" data-gallery-item-tag="{{ item['tag'] }}" style="cursor: pointer;">
            <a data-title="{{ item['tag'] }} &middot; {{ item['description'] }}">
              <img src="{{ item['attachment'].photo.thumb_url }}" alt="{{ item['description'] }}">
            </a>
            <span class="mt-2">{{ item['tag'] }}</span>
          </div>
          {% endif %}
          {%- endfor %}
        </div>
      </div>
    </div>
    {%- endif %}

  </div>
  <div class="tab-pane fade" id="messages-panel" role="tabpanel" aria-labelledby="messages-tab">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="thead-light">
          <tr>
            <th scope="col">{{ _('Text') }}</th>
            <th scope="col" class="col-1">{{ _('Direction') }}</th>
            <th scope="col" class="col-2">{{ _('Mobile') }}</th>
            <th scope="col" class="col-2">{{ _('Date') }}</th>
            <th scope="col" class="col-1">{{ _('Time') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for (left_message, right_message) in messages %}
          {% if left_message.direction == 'IN' %}
          {%- if right_message != None %}
          <tr>
            <td class="text-monospace">{{ right_message.text }}</td>
            <td class="text-monospace">{{ right_message.direction.value }}</td>
            {% if perms.edit_participant.can() -%}
            <td class="text-monospace">{% if right_message.participant %}<a href="{{ url_for('participants.participant_edit', id=right_message.participant.id) }}">{{ right_message.sender }}</a>{% else %}{{ right_message.sender }}{% endif %}</td>
            {% else -%}
            <td class="text-monospace">{{ right_message.sender }}</td>
            {% endif -%}
            <td class="text-monospace timestamp-date" data-timestamp="{{ right_message.received|timestamp }}">{{ right_message.received.strftime('%b %d %Y') }}</td>
            <td class="text-monospace timestamp-time" data-timestamp="{{ right_message.received|timestamp }}">{{ right_message.received.strftime('%I:%M %p') }}</td>
          </tr>
          {%- else %}
          <tr>
            <td class="text-monospace text-muted text-center" colspan="5"><em>{{ _('No Outgoing Message') }}</em></td>
          </tr>
          {%- endif %}
          <tr>
            <td class="text-monospace">{{ left_message.text }}</td>
            <td class="text-monospace">{{ left_message.direction.value }}</td>
            {% if perms.edit_participant.can() -%}
            <td class="text-monospace">{% if left_message.participant %}<a href="{{ url_for('participants.participant_edit', id=left_message.participant.id) }}">{{ left_message.sender }}</a>{% else %}{{ left_message.sender }}{% endif %}</td>
            {% else -%}
            <td class="text-monospace">{{ left_message.sender }}</td>
            {% endif -%}
            <td class="text-monospace timestamp-date" data-timestamp="{{ left_message.received|timestamp }}">{{ left_message.received.strftime('%b %d %Y') }}</td>
            <td class="text-monospace timestamp-time" data-timestamp="{{ left_message.received|timestamp }}">{{ left_message.received.strftime('%I:%M %p') }}</td>
          </tr>
          {% else %}
          <tr>
            <td class="text-monospace">{{ left_message.text }}</td>
            <td class="text-monospace">{{ left_message.direction.value }}</td>
            {% if perms.edit_participant.can() -%}
            <td class="text-monospace">{% if left_message.participant %}<a href="{{ url_for('participants.participant_edit', id=left_message.participant.id) }}">{{ left_message.sender }}</a>{% else %}{{ left_message.sender }}{% endif %}</td>
            {% else -%}
            <td class="text-monospace">{{ left_message.sender }}</td>
            {% endif -%}
            <td class="text-monospace timestamp-date" data-timestamp="{{ left_message.received|timestamp }}">{{ left_message.received.strftime('%b %d %Y') }}</td>
            <td class="text-monospace timestamp-time" data-timestamp="{{ left_message.received|timestamp }}">{{ left_message.received.strftime('%I:%M %p') }}</td>
          </tr>
          {% endif %}
          {% else %}
          <tr class="table-warning">
            <td class="text-center text-muted" colspan="5">{{ _('No Data Available') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="tab-pane fade" id="critical-incidents-panel" role="tabpanel" aria-labelledby="critical-incidents-tab">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="thead-light">
          <tr>
            <th scope="col" class="text-right{{ '' if incidents.count() > 0 else ' col-1' }}">{{ _('ID') }}</th>
            <th scope="col" class="col-1">{{ _('Form') }}</th>
            <th scope="col">{{ _('Incident Type') }}</th>
            <th scope="col" class="col-1 text-center">{{ _('Status') }}</th>
            <th scope="col" class="col-2">{{ _('Date') }}</th>
            <th scope="col" class="col-1">{{ _('Time') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for incident in incidents %}
          {% for group in incident.form.data.groups[:1] %}
          {% for field in group.fields[:1] %}
          {%- set field_options = field.options|reverse_dict() if field.options else None %}
          {% if field.tag in incident.data %}
          <tr>
            <td class="text-monospace text-right"><a href="{{ url_for('submissions.submission_edit', submission_id=incident.id) }}">{{ incident.id }}</a></td>
            <td class="text-monospace">{{ incident.form.prefix }}</td>
            <td class="text-monospace"><strong>{{ incident.data[field.tag] }}</strong> &mdash; {{ field_options[incident.data[field.tag]] if field_options else field.description }}</td>
            <td class="text-monospace text-center">
              {%- set status = incident.incident_status -%}
              {%- if status == 'confirmed' -%}
              <i class="fa fa-check text-success" aria-hidden="true" title="{{ _('Confirmed') }}"></i>
              {%- elif status == 'rejected' -%}
              <i class="fa fa-circle text-danger" aria-hidden="true" title="{{ _('Rejected') }}"></i>
              {%- elif status == 'citizen' -%}
              <i class="fa fa-users text-primary" aria-hidden="true" title="{{ _('Citizen Report') }}"></i>
              {%- else -%}
              <i class="fa fa-exclamation-triangle text-warning" aria-hidden="true" title="{{ _('Unmarked') }}"></i>
              {%- endif -%}
            </td>
            <td class="text-monospace timestamp-date" data-timestamp="{{ incident.created|timestamp }}">{{ incident.created.strftime('%b %d %Y') }}</td>
            <td class="text-monospace timestamp-time" data-timestamp="{{ incident.created|timestamp }}">{{ incident.created.strftime('%I:%M %p') }}</td>
          </tr>
          {% endif %}
          {% endfor %}
          {% endfor %}
          {% else %}
          <tr class="table-warning">
            <td class="text-center text-muted" colspan="6">{{ _('No Data Available') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="tab-pane fade" id="changelog-panel" role="tabpanel" aria-labelledby="changelog-tab">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="thead-light">
          <tr>
            <th scope="col" class="col-2">{{ _('User') }}</th>
            <th scope="col" class="col-2">{{ _('Date') }}</th>
            <th scope="col" class="col-1">{{ _('Time') }}</th>
            <th scope="col">{{ _('Description') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for changeset in changelog %}
          <tr>
            <td class="text-monospace">{{ changeset.identity }}</td>
            <td class="text-monospace timestamp-date" data-timestamp="{{ changeset.timestamp|timestamp }}">{{ changeset.timestamp.strftime('%b %d %Y') }}</td>
            <td class="text-monospace timestamp-time" data-timestamp="{{ changeset.timestamp|timestamp }}">{{ changeset.timestamp.strftime('%I:%M %p') }}</td>
            <td class="text-monospace">
              {%- for attr in changeset.changes()['added'] %}<span class="badge badge-pill badge-success" style="cursor: pointer" data-toggle="tooltip" title="{{ _('Added') }}">{{ attr }}: {{ changeset.data[attr] }}</span> {% endfor %}
              {%- for attr in changeset.changes()['changed'] %}<span class="badge badge-pill badge-warning" style="cursor: pointer" data-toggle="tooltip" title="{{ _('Changed') }}">{{ attr }}: {{ changeset.data[attr] }}</span> {% endfor %}
              {%- for attr in changeset.changes()['deleted'] %}<span class="badge badge-pill badge-danger" style="cursor: pointer" data-toggle="tooltip" title="{{ _('Deleted') }}">{{ attr }}</span> {% endfor -%}
            </td>
          </tr>
          {% else %}
          <tr class="table-warning">
            <td class="text-center text-muted" colspan="4">{{ _('No Data Available') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="tab-pane fade" id="calllog-panel" role="tabpanel" aria-labelledby="calllog-tab">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="thead-light">
          <tr>
            <th scope="col" class="col-2">{{ _('User') }}</th>
            <th scope="col" class="col-2">{{ _('Date') }}</th>
            <th scope="col" class="col-1">{{ _('Time') }}</th>
            <th scope="col">{{ _('Note') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for call in call_log %}
          <tr>
            <td class="text-monospace">{{ call.user.email }}</td>
            <td class="text-monospace timestamp-date" data-timestamp="{{ call.created|timestamp }}">{{ call.created.strftime('%b %d %Y') }}</td>
            <td class="text-monospace timestamp-time" data-timestamp="{{ call.created|timestamp }}">{{ call.created.strftime('%I:%M %p') }}</td>
            <td class="text-monospace">
              {% if call.description %}{{ call.description }}{% else %}<em class="text-muted">-</em>{% endif %}
            </td>
          </tr>
          {% else %}
          <tr class="table-warning">
            <td class="text-center text-muted" colspan="4">{{ _('No Data Available') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<input type="hidden" name="{{ master_form['location'].name }}" value="{{ master_form['location'].data.id|default('__None', true) }}" />

{# comments #}
<a name="comments"></a>
<div class="row">
  <div class="col-md-12 {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}">
    <table class="table table-bordered" id="comments">
    {% for comment in comments %}
      <tr>
        <td>
          <p><strong>{{ comment.user.email }}</strong> &middot; <em class="tonow" data-timestamp="{{ comment.submit_date|timestamp }}">{{ comment.submit_date.strftime('%b %d %Y %I:%M %p') }}</em></p>
          <p>{{ comment.comment }}</p>
        </td>
      </tr>
    {% else %}
      <tr class="warning">
        <td style="text-align:center">{{ _('No Comment') }}</td>
      </tr>
    {% endfor %}
      <tr id="save_comment">
        <td>
          <label for="comment" class="sr-only">{{ _('Comment') }}</label>
          <textarea id="comment" class="form-control tracked"></textarea>
          <input id="submission" name="submission" type="hidden" value="{{ submission.id|string }}">
          <input id="postcomment" type="button" class="btn btn-primary pull-right" value="{{ _('Add Comment') }}" style="margin-top:.5em;">
        </td>
      </tr>
    </table>
  </div>
</div>
{%- else %}
{#- Critical Incidents #}
{%- if submission_form.errors %}
<div class="alert alert-danger alert-dismissible fade show mt-2 mb-0 {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}" role="alert">
  <h5 class="alert-heading">{{ _('Data Validation Errors') }}</h5>
  <div>{{ _('The data you entered are not valid. Please check the affected questions and correct them.') }}</div>
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div>
{%- endif %}

<div class="card-body tab-content px-0 {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}">
  <div>
    {% for group in form.data.groups %}
    <div class="card bg-light mb-3">
      <div class="card-header">
        <h5 class="mb-0">{{ group.name }}</h5>
      </div>
      <div class="card-body py-0 px-0">
        <table class="table table-borderless mb-0 table-responsive">
          <tbody>
          {% for field in group.fields %}
            <tr>
              <td class="align-middle" style="width: 0.1%; white-space: nowrap;"><strong>{{ field.tag }}</strong></td>
              <td class="align-middle">{{ field.description }}</td>
              {% if submission_form[field.tag].errors -%}
              <td class="col-2 align-middle"><label for="{{ submission_form[field.tag].id }}" class="sr-only">{{ submission_form[field.tag].label.text }}</label>{{ render_field(submission_form[field.tag], field.type, description=field.description, klass_='form-control tracked text-monospace is-invalid', perms=perms) }}</td>
              {%- else -%}
              <td class="col-2 align-middle"><label for="{{ submission_form[field.tag].id }}" class="sr-only">{{ submission_form[field.tag].label.text }}</label>{{ render_field(submission_form[field.tag], field.type, description=field.description, klass_='form-control tracked text-monospace', perms=perms) }}</td>
              {%- endif %}
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}

    <div class="card bg-light">
      <div class="card-body py-0 px-0">
        <table class="table table-borderless mb-0 table-responsive">
          <tbody>
            <tr>
              <td style="width: 0.1%; white-space: nowrap;">&nbsp;&nbsp;</td>
              <td class="text-right">
                <strong>{{ _('Description')}}</strong>
              </td>
              <td class="col-6"><label for="{{ submission_form.description.id }}" class="sr-only">{{ submission_form.description.label.text }}</label>{{ submission_form.description(class_='form-control tracked', rows=4) }}</td>
            </tr>
            <tr>
              <td class="align-middle" style="width: 0.1%; white-space: nowrap;">&nbsp;&nbsp;</td>
              <td class="align-middle text-right">
                <strong>{{ _('Status')}}</strong>
              </td>
              <td class="col-6 align-middle"><label for="{{ submission_form.status.id }}" class="sr-only">{{ submission_form.status.label.text }}</label>{{ submission_form.status(class_='form-control tracked custom-select') }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    {% if submission.image_attachments -%}
    <div class="card text-white bg-secondary mt-3" id="images">
      <div class="card-header">
        <h5 class="mb-0">{% trans %}Images{% endtrans %}</h5>
      </div>
      <div id="carousel-body-el" class="card-body">
        <div class='slick m-3'>
          {% for item in submission.get_image_data() -%}
          {% if item['attachment'] %}
          <div class="d-flex flex-column align-items-center justify-content-center mb-3" data-gallery-item-tag="{{ item['tag'] }}" style="cursor: pointer;">
            <a data-title="{{ item['tag'] }} &middot; {{ item['description'] }}">
              <img src="{{ item['attachment'].photo.thumb_url }}" alt="{{ item['description'] }}">
            </a>
            <span class="mt-2">{{ item['tag'] }}</span>
          </div>
          {% endif %}
          {%- endfor %}
        </div>
      </div>
    </div>
    {%- endif %}

  </div>
</div>
{%- endif %}
</form>

<div class="modal fade {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}" id="addCallLogModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('Add Call Log') }}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mb-n2">
        <div class="form-group">
          <label for="calllog_description">{{ _('Note') }}</label>
          <textarea id="calllog_description" class="form-control" rows="5" data-participant="{{ submission.participant.id }}"></textarea>
          <small class="form-text text-muted">
            {% trans %}You may (optionally) include details of your call or interaction with the participant here.{% endtrans %}
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <div class="spinner-grow spinner-grow-sm inline-block invisible" id="calllog_loader" role="status"><span class="sr-only">Loading...</span></div> <button type="button" id="contactSaveBtn" class="btn btn-primary">{{ _('Save') }}</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}" id="imageDeleteConfirmModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('Delete Image?') }}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mb-n2">
        <p id="confirm-delete-message"></p>
        <p><strong id="deleteTag"></strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _('No') }}</button>
        <button type="button" class="btn btn-danger" id="confirmImageDelete">{{ _('Yes, delete') }}</button>
      </div>
    </div>
  </div>
</div>
</div>
<div id="rhs" class="d-none bg-dark">
  <ul class="list-group" id="image-viewer-source">
    {% for img_data in submission.get_image_data() %}
    {% if img_data['attachment'] %}
    <li class="list-group-item d-flex justify-content-between align-items-center" data-viewer-item-tag="{{ img_data['tag'] }}">
      <strong>{{ img_data['tag'] }}</strong> <img src="{{ img_data['attachment'].photo.thumb_url }}" alt="{{ img_data['tag'] }}" class="img-fluid" data-original="{{ img_data['attachment'].photo.url }}" description="{{ img_data['description'] }}" tag="{{ img_data['tag'] }}" unsaved="false">
    </li>
    {% endif %}
    {% endfor %}
  </ul>
</div>
</div>
{% endblock %}



{%- block footer -%}
  <div class="mt-n2 pb-2 d-flex justify-content-end">
    <div>
      <button type="button" id="addCallLogBtn" class="btn btn-success d-none d-md-inline-block" data-toggle="modal" data-target="#addCallLogModal">{{ _('Add Call Log') }}</button>
      <button type="button" id="cancelBtn" class="btn btn-secondary">{{ _('Cancel') }}</button>
      <button type="button" id="saveBtn" class="btn btn-primary">{{ _('Save') }}</button>
    </div>
  </div>
{%- endblock %}



{%- block scripts %}
<script type="text/javascript" src="{{ asset_url_for('moment.js') }}" charset="utf-8"></script>
<script src="{{ url_for('static', filename='js/bootstrap-switch-button.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/slick.js') }}"></script>
<script src="{{ url_for('static', filename='js/split.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/lodash.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/compressor.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/viewer.min.js') }}"></script>
<script type="text/javascript">
  moment.lang('{{ g.locale }}');

  document.addEventListener('click', function (event) {
    let element = event.target.closest('label[data-delete-label]');
    if (element && !element.classList.contains('disabled')) {
      popupDeleteModal(element.dataset.deleteLabel);
      return;
    }

    // process split pane activation
    element = event.target.closest('label[data-presence-label]');
    if (element) {
      buildSplitView(element.dataset.presenceLabel);
      return;
    };
  });

  let carouselBody = document.querySelector('#carousel-body-el');
  if (carouselBody) {
    carouselBody.addEventListener('click', (event) => {
      let element = event.target.closest('div[data-gallery-item-tag]');
      if (element) {
        buildSplitView(element.dataset.galleryItemTag);
        return;
      }
    });
  }

  let originalImageInfo = {};
  Array.from(document.querySelectorAll('#image-viewer-source > li')).forEach(listEl => {
    let tagElement = listEl.querySelector('strong');
    let imageElement = listEl.querySelector('img');

    originalImageInfo[tagElement.textContent] = {
      thumbnail: imageElement.src,
      url: imageElement.dataset.original
    };
  });

  document.querySelector('#confirmImageDelete').addEventListener('click', function () {
    $('#imageDeleteConfirmModal').modal('hide');

    let tag = document.querySelector('#deleteTag').textContent;
    if (isImageLoaded(tag)) {
      deleteLocalImage(tag);
    } else {
      if (originalImageInfo[tag]) {
        deleteRemoteImage(tag);
      }
    }
  });

  const isImageLoaded = function (tag) {
    let selector = 'input[data-image-tag="' + tag + '"]';
    let fileInput = document.querySelector(selector);
    if (fileInput.files.length > 0) {
      return true;
    } else {
      return false;
    }
  };

  const updateUIAfterDelete = function (tag, remoteDeleted) {
    let galleryItemSelector = 'div[data-gallery-item-tag=' + tag + ']';
    let viewerItemSelector = 'li[data-viewer-item-tag=' + tag + ']';
    let deleteLabelSelector = 'label[data-delete-label=' + tag + ']';
    let imagePresenceLabelSelector = 'label[data-presence-label=' + tag + ']';
    let imagePresenceLabel = document.querySelector(imagePresenceLabelSelector);
    let deleteLabel = document.querySelector(deleteLabelSelector);
    let galleryItemElement = document.querySelector(galleryItemSelector);
    let viewerItemElement = document.querySelector(viewerItemSelector);

    // only disable the delete label if the remote
    // image was present and deleted
    if (imagePresenceLabel.dataset.remote) {
      if (remoteDeleted) {
        if (deleteLabel) {
          deleteLabel.classList.toggle('disabled');
          deleteLabel.style.cursor = 'default';
        }

        imagePresenceLabel.classList.toggle('disabled');
        imagePresenceLabel.firstElementChild.firstElementChild.classList.remove('text-white');
        imagePresenceLabel.classList.remove('bg-primary');
        imagePresenceLabel.firstElementChild.firstElementChild.classList.add('text-dark');
        imagePresenceLabel.style.cursor = 'default';
        delete imagePresenceLabel.dataset.presenceLabel;
        delete imagePresenceLabel.dataset.remote;

        if (galleryItemElement) {
          galleryItemElement.remove();
        }
        if (viewerItemElement) {
          viewerItemElement.remove();
        }
      }
    } else {
      if (deleteLabel) {
        deleteLabel.classList.toggle('disabled');
        deleteLabel.style.cursor = 'default';
      }

      imagePresenceLabel.classList.toggle('disabled');
      imagePresenceLabel.firstElementChild.firstElementChild.classList.remove('text-white');
      imagePresenceLabel.classList.remove('bg-primary');
      imagePresenceLabel.firstElementChild.firstElementChild.classList.add('text-dark');
      imagePresenceLabel.style.cursor = 'default';
      delete imagePresenceLabel.dataset.presenceLabel;
    }
    
    destroySplitView();
  }

  let deleteLocalImage = function (tag) {
    let deleteLabel = document.querySelector('label[data-delete-label=' + tag + ']');
    let fileInput = document.querySelector('input[data-image-tag=' + tag + ']');
    let imagePresenceLabel = document.querySelector('label[data-presence-label=' + tag + ']');
    let viewerItemElement = document.querySelector('li[data-viewer-item-tag=' + tag + ']');

    // clear the file input
    fileInput.value = null;
    fileInput.files = (new DataTransfer()).files;

    // change the labels
    if (!originalImageInfo[tag]) {
      // delete label
      deleteLabel.classList.add('disabled');
      deleteLabel.style.cursor = 'default';

      // change the file presence label
      imagePresenceLabel.classList.add('disabled');
    }

    // change the file loaded label
    deleteLabel.nextElementSibling.classList.remove('btn-primary');
    deleteLabel.nextElementSibling.classList.add('btn-secondary');

    // update the viewer item
    if (originalImageInfo[tag]) {
      let imageEl = viewerItemElement.querySelector('img');
      imageEl.src = originalImageInfo[tag].thumbnail;
      imageEl.dataset.original = originalImageInfo[tag].url;
    } else {
      viewerItemElement.remove();
    }

    destroySplitView();
  };

  let deleteRemoteImage = function (tag) {
    let deleteLabel = document.querySelector('label[data-delete-label=' + tag + ']');
    let galleryItemElement = document.querySelector('div[data-gallery-item-tag=' + tag + ']');
    let imagePresenceLabel = document.querySelector('label[data-presence-label=' + tag + ']');
    let viewerItemElement = document.querySelector('li[data-viewer-item-tag=' + tag + ']');

    const deleteEndpoint = "{{ url_for('submissions.delete_image', submission_id=submission.id) }}";
    const csrfToken = document.querySelector('meta[name=csrf-token]').content;
    let formData = new FormData();
    formData.append('tag', tag);

    fetch(deleteEndpoint, {
      body: formData,
      headers: {
        'X-CSRFToken': csrfToken,
      },
      method: 'POST'
    })
    .then(response => response.ok)
    .then(deleteSuceeded => {
      if (deleteSuceeded) {
        // change delete label
        deleteLabel.classList.add('disabled');
        deleteLabel.style.cursor = 'default';
  
        // change image presence label
        imagePresenceLabel.classList.remove('bg-primary');
        imagePresenceLabel.classList.add('disabled');
        imagePresenceLabel.querySelector('i').classList.remove('fas', 'text-white');
        imagePresenceLabel.querySelector('i').classList.add('far', 'text-dark');
  
        if (galleryItemElement) {
          galleryItemElement.remove();
        }

        if (viewerItemElement) {
          viewerItemElement.remove();
        }

        destroySplitView();
      }
    });
  };

  const fileChangeHandler = function (changeEventObj) {
    let fileInput = changeEventObj.target;
    let label = fileInput.parentElement;
    let tag = fileInput.dataset.imageTag;
    let deleteLabelSelector = 'label[data-delete-label=' + tag + ']';
    document.querySelector(deleteLabelSelector).style.cursor = 'pointer';
    if (fileInput.files.length > 0) {
      document.querySelector(deleteLabelSelector).classList.remove('disabled');
      label.classList.remove('btn-secondary');
      label.classList.add('btn-primary');
      let otherLabel = label.previousElementSibling.previousElementSibling;
      otherLabel.dataset.presenceLabel = tag;
      otherLabel.classList.remove('disabled');

      // insert/replace the item in the image preview
      let viewerItemSelector = 'li[data-viewer-item-tag=' + tag + ']';
      let selectedImageViewerEl = document.querySelector(viewerItemSelector);
      let imageElement;
      if (!selectedImageViewerEl) {
        let imageViewerEl = document.querySelector('#image-viewer-source');
        let newListItemNode = document.createElement('li');
        newListItemNode.dataset.viewerItemTag = tag;
        newListItemNode.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
        imageElement = document.createElement('img');
        imageElement.classList.add('img-fluid');
        let labelElement = document.createElement('strong');
        labelElement.innerText = tag;
        newListItemNode.appendChild(labelElement);
        newListItemNode.appendChild(imageElement);
        imageViewerEl.appendChild(newListItemNode);
      } else {
        imageElement = selectedImageViewerEl.querySelector('img');
      }

      let reader = new FileReader();
      reader.readAsDataURL(fileInput.files[0]);
      reader.addEventListener('load', function(evt) {
        let compressor = new Compressor(fileInput.files[0], {
          maxHeight: 128,
          maxWidth: 128,
          success: function(result) {
            imageElement.src = URL.createObjectURL(result);
            imageElement.alt = tag;
            imageElement.setAttribute('tag', tag);
            imageElement.setAttribute('description', fileInput.dataset.imageDescription);
            imageElement.setAttribute('unsaved', 'true');
            imageElement.dataset.original = evt.target.result;
            buildViewer(tag);
          }
        });
        imageElement.dataset.original = reader.result;
      });
    } else {
      document.querySelector(deleteLabelSelector).classList.add('disabled');
      label.classList.add('btn-secondary');
      label.classList.remove('btn-primary');
    }
  };

  const imageViewerSource = document.querySelector('#image-viewer-source');
  let splitView = null;
  let splitViewActive = false;
  let imageViewer = null;

  function getImageTags() {
    let elementList = Array.prototype.slice.call(imageViewerSource.querySelectorAll('li > img'))
    return elementList.map(function(imgEl) {
      return imgEl.alt;
    });
  }

  let buildViewer = _.debounce(function(startTag) {
    let currentTag = null;
    if (imageViewer) {
      currentTag = imageViewer.image.alt;
      imageViewer.destroy();
      imageViewer = null;
    }

    imageViewer = new Viewer(imageViewerSource, {
      inheritedAttributes: ['crossOrigin', 'decoding', 'isMap', 'loading', 'referrerPolicy', 'sizes', 'srcset', 'useMap', 'description', 'tag', 'unsaved'],
      inline: true,
      minHeight: (window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight) - 100,
      title: function(image, imageData) {
        const tag = image.getAttribute('tag');
        const description= image.getAttribute('description');
        const status = image.getAttribute('unsaved');

        if (status === 'false') {
          return `${tag} · ${description} (${imageData.naturalWidth} × ${imageData.naturalHeight})`;
        } else {
          return `${tag} · ${description} · {{ _('Not saved') }} (${imageData.naturalWidth} × ${imageData.naturalHeight})`;
        }
      },
      toolbar: {
        zoomIn: true,
        zoomOut: true,
        reset: true,
        oneToOne: true,
        play: false,
        prev: true,
        next: true,
        rotateLeft: true,
        rotateRight: true,
        flipHorizontal: true,
        flipVertical: true,
        download: function() {
          const anchor = document.createElement('a');
          anchor.href = imageViewer.image.src;
          anchor.download = slugify(`{{ submission.event.name }}-{{ submission.participant.participant_id }}-${imageViewer.image.alt}`);
          document.body.appendChild(anchor);
          anchor.click();
          document.body.removeChild(anchor);
        },
        delete: function() {
          popupDeleteModal(imageViewer.image.alt);
        },
        close: function() {
          destroySplitView();
        }
      },
      url: 'data-original'
    });

    if (startTag) {
      const idx = getImageTags().indexOf(startTag);
      if (idx !== -1) {
        imageViewer.view(idx);
      }
    } else if (currentTag) {
      const idx = getImageTags().indexOf(startTag);
      if (idx !== -1) {
        imageViewer.view(idx);  
      }
    }
  }, 300);

  const slugify = function (text) {
    // stolen from https://gist.github.com/codeguy/6684588
    return text
      .toString()                   // Cast to string (optional)
      .normalize('NFKD')            // The normalize() using NFKD method returns the Unicode Normalization Form of a given string.
      .toLowerCase()                // Convert the string to lowercase letters
      .trim()                       // Remove whitespace from both sides of a string (optional)
      .replace(/\s+/g, '-')         // Replace spaces with -
      .replace(/[^\w\-]+/g, '')     // Remove all non-word chars
      .replace(/\_/g,'-')           // Replace _ with -
      .replace(/\-\-+/g, '-')       // Replace multiple - with single -
      .replace(/\-$/g, '');         // Remove trailing -
  };

  function buildSplitView(startTag) {
    if (splitViewActive) {
      buildViewer(startTag);
      return;
    }

    splitViewActive = true;
    let lhs = document.querySelector('#lhs');
    let rhs = document.querySelector('#rhs');
    let container = document.querySelector('main').firstElementChild;
    container.classList.remove('container');
    container.classList.add('px-1');
    lhs.classList.add('overflow-auto');
    rhs.classList.remove('d-none');
    rhs.classList.add('overflow-hidden');
    lhs.style.height = rhs.style.height = '80vh';
    lhs.parentElement.classList.add('split');
    
    splitView = Split(['#lhs', '#rhs'], {
      sizes: [50, 50],
      onDragEnd: function(sizes) {
        buildViewer();
      }
    });
    buildViewer(startTag);
  }
  
  function destroySplitView() {
    if (!splitViewActive) {
      return;
    }

    if (imageViewer) {
      imageViewer.destroy();
    }

    splitViewActive = false;
    let lhs = document.querySelector('#lhs');
    let rhs = document.querySelector('#rhs');
    let container = document.querySelector('main').firstElementChild;
    container.classList.add('container');
    container.classList.remove('px-1');
    splitView.setSizes([100, 0]);
    lhs.classList.remove('overflow-auto');
    rhs.classList.add('d-none');
    rhs.classList.remove('overflow-hidden');
    lhs.style.height = rhs.style.height = '';
    lhs.parentElement.classList.remove('split');
    splitView.destroy();
    splitView = null;
  }

  function popupDeleteModal(tag) {
    document.querySelector('#deleteTag').textContent = tag;
    const localMessage = "{{ _('Are you sure you want to delete the current loaded image for the following question?') }}";
    const remoteMessage = "{{ _('Are you sure you want to delete the saved image for the following question?') }}";

    let messageElement = document.querySelector('#confirm-delete-message');
    if (isImageLoaded(tag)) {
      messageElement.textContent = localMessage;
    } else {
      messageElement.textContent = remoteMessage;
    }
    $('#imageDeleteConfirmModal').modal('show');
  }

  $(function () {
    $('[data-toggle="tooltip"]').tooltip();
    $('.slick').slick({
        dots: true,
        infinite: true,
        slidesToShow: 5,
        slidesToScroll: 5
    });

    $('[data-context="hidden_file"]').on('change', fileChangeHandler);
    $('label > span[role="button"').bind('keypress keyup', function (evt) {
      if (evt.which === 32 || evt.which === 13) {
        evt.preventDefault();
        var spanButton = this;
        var fileInput = spanButton.parentElement.children[1];
        fileInput.click();
      }
    });

    $('.tonow').each(function (index) {
      var timestamp = moment.unix(Number($(this).data('timestamp')));
      this.innerText = timestamp.fromNow();
    });
    $('.timestamp-date').each(function (index) {
      var timestamp = moment.unix(Number($(this).data('timestamp')));
      this.innerText = timestamp.format('ll');
    });
    $('.timestamp-time').each(function (index) {
      var timestamp = moment.unix(Number($(this).data('timestamp')));
      this.innerText = timestamp.format('LT');
    });

    // provide warning before navigating away if form was modified
    $(document).on('change', '.tracked', function(e) {
      window.onbeforeunload = function () { return true; };
    });

    var csrftoken = $('meta[name=csrf-token]').attr('content');

    $('#postcomment').click(function() {
      var comment = $('#comment').val(), submission = $('#submission').val();
      if (comment) {
        $.ajax({
          url: "{{ url_for('submissions.comment_create_view') }}",
          type: 'POST',
          data: {comment: comment, submission: submission},
          beforeSend: function (xhr, settings) {
            $('#comment').attr('disabled', 'disabled');
            $('#save').attr('disabled', 'disabled');
            $('#loader').attr('style', 'visibility:visible;');
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
              xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
          }
        }).done(function(data) {
          $('#comment').val("");  // clear the comment textbox
          // if there's a table row displaying "No comment.", remove it
          $('#comments tr.warning').remove();
          $('#save_comment').before('<tr><td><p><strong>' + data.user + '</strong> · <em>' + moment.unix(data.date).fromNow() + '</em></p><p>' + data.comment + '</p></td></tr>');
        }).always(function () {
          // Re-enable
          $('#comment').removeAttr('disabled');
          $('#save').removeAttr('disabled');
          $('#loader').attr('style', 'visibility:hidden;');
        });
      }
    });

    $('#toggle_verification').click(function() {
      var phone = $(this).data('phone');
      var participant = $(this).data('participant');
      var submission = $(this).data('submission');

      if (phone && participant) {
        $.ajax({
          url: "{{ url_for('participants.toggle_phone_verification') }}",
          type: 'POST',
          data: {phone: phone, participant: participant, submission: submission},
          beforeSend: function (xhr, settings) {
            $('#toggle_verification_spinner').removeClass('invisible');
            $('#toggle_verification').css('pointer-events', 'none');
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
              xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
          },
          success: function(data) {
            if (data == '1') {
              $('#toggle_verification_badge').removeClass('badge-warning');
              $('#toggle_verification_badge').addClass('badge-success');
              $('#toggle_verification_badge').html('{{ _("Verified") }}');
            } else {
              $('#toggle_verification_badge').removeClass('badge-success');
              $('#toggle_verification_badge').addClass('badge-warning');
              $('#toggle_verification_badge').html('{{ _("Unverified") }}');
            }
            $('#toggle_verification_spinner').addClass('invisible');
            $('#toggle_verification').css('pointer-events', 'auto');
          },
          error: function () {
            // Re-enable
            $('#toggle_verification_spinner').addClass('invisible');
            $('#toggle_verification').css('pointer-events', 'auto');
          }
        });
      }
    });

    $('#contactSaveBtn').click(function() {
      var description = $('#calllog_description').val(), participant = $('#calllog_description').data('participant');

      $.ajax({
        url: "{{ url_for('participants.log_call') }}",
        type: 'POST',
        data: {description: description, participant: participant},
        beforeSend: function (xhr, settings) {
          $('#contactSaveBtn').attr('disabled', 'disabled');
          $('#calllog_description').attr('disabled', 'disabled');
          $('#calllog_loader').attr('style', 'visibility:visible;');
          if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
          }
        }
      }).done(function(data) {
        $('#calllog_description').val("");
        $('#addCallLogModal').modal('hide');
      }).always(function () {
        // Re-enable
        $('#calllog_description').removeAttr('disabled');
        $('#contactSaveBtn').removeAttr('disabled');
        $('#calllog_loader').attr('style', 'visibility:hidden;');
      });
    });

    $('.obs1').click(function(){
        $('table tbody tr td.obs-on :input').prop('disabled', false);
        $('table tbody tr td.ps-on :input').prop('disabled', true);
    });
    $('.ps').click(function(){
        $('table tbody tr td.ps-on :input').prop('disabled', false);
        $('table tbody tr td.obs-on :input').prop('disabled', true);
    });

    $('#saveBtn').click(function(){
      window.onbeforeunload = null;
      $('form').submit();
    });

    $('#cancelBtn').click(function(){
      var url = '{% if request.environ.get('HTTP_REFERER') == request.url %}{{ url_for('submissions.submission_list', form_id=form.id) }}{% else %}{{ request.environ.get('HTTP_REFERER', url_for('submissions.submission_list', form_id=form.id)) }}{% endif %}';
      window.onbeforeunload = null;
      window.location.href = url;
    });
  });

  handlingScroll = false;
  minimized = false;

  var minimizeTable = function () {
    if (!handlingScroll) {
      handlingScroll = true;
      $("#infocard tr:not(.important)").slideUp(0);
      $("#infocard").get(0).scrollIntoView();
      setTimeout(function () { handlingScroll = false; minimized = true; }, 50);
    }
  };
  var maximizeTable = function () {
    if (!handlingScroll) {
      handlingScroll = true;
      $("#infocard tr:not(.important)").slideDown(0);
      if (minimized) {
        $("body").get(0).scrollIntoView();
      }
      setTimeout(function () { handlingScroll = false; minimized = false; }, 50);
    }
  };

  $(window).scroll(function () {
    if ($("#infocard").offset().top - $(window).scrollTop() == 0) {
      minimizeTable();
    } else {
      maximizeTable();
    }
  });
</script>
{%- endblock %}
