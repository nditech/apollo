{% extends 'admin/base.html' %}
{% block toolbar %}

{% endblock %}

{% block head_css %}
{{ super() }}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/jquery.handsontable.full.min.css') }}">
{% endblock %}

{% block body %}
<div class="d-flex justify-content-between align-items-md-center flex-column flex-md-row mb-n2">
  <nav class="nav mb-4" aria-label="breadcrumb">
    <ol class="breadcrumb mb-n2">
        {% for breadcrumb in breadcrumbs %}
        <li class="breadcrumb-item {%- if loop.last %} active{% endif %}" {%- if loop.last %} aria-current="page"{% endif %}>
          {% if breadcrumb.url -%}
          <a href="{{ breadcrumb.url }}" class="text-decoration-none">{{ breadcrumb.text or breadcrumb }}</a>
          {%- else -%}
          {{ breadcrumb.text or breadcrumb }}
          {%- endif %}
        </li>
        {% endfor %}
    </ol>
  </nav>
  <div class="d-flex justify-content-between align-items-start flex-column flex-md-row">
    <div class="btn-toolbar d-none d-md-flex" role="toolbar">
      <a class="btn btn-primary mr-2" href="#" id="saveBtn">{{ _('Save') }}</a>
    </div>
  </div>
</div>

<form method="post">
<div class="row mt-3">
  <div class="col-md-12">
    <div id="check_builder" data-checks='{{ check_data|tojson}}'></div>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" /><input type="hidden" name="postdata" id="postdata" value="" />
  </div>
</div>
</form>
{% endblock %}

{% block tail_js %}
{{ super() }}
<script src="{{ url_for('static', filename='js/jquery.handsontable.full.min.js') }}"></script>
<script>
  var save;
  $(document).ready(function() {
    var check_data = JSON.parse(document.getElementById('check_builder').dataset.checks);
    $('#check_builder').handsontable({
      data: check_data,
      colHeaders: ['Description', 'LHS', 'Comparator', 'RHS'],
      columns: [{
        type: 'text'
      }, {
        type: 'text'
      }, {
        type: 'dropdown',
        source: ['>', '<', '=', '>=', '<=', '!=']
      }, {
        type: 'text'
      }],
      rowHeaders: true,
      minSpareRows: 1,
      stretchH: 'all',
      contextMenu: true
    });

    save = function() {
      handsontable = $('#check_builder').handsontable('getInstance');
      $('#postdata').val(JSON.stringify(handsontable.getData()));
      $('form').submit();
    }

    $('#saveBtn').click(function(){
      save();
    });
  });
</script>
{% endblock %}
