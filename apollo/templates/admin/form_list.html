{% extends "admin/base.html" %}

{%- block body %}
<div class="d-flex justify-content-between align-items-md-center flex-row mb-3">
  <nav class="nav mb-2" aria-label="breadcrumb">
    <ol class="breadcrumb mb-n2">
        {% for breadcrumb in breadcrumbs %}
        <li class="breadcrumb-item {%- if loop.last %} active{% endif %}" {%- if loop.last %} aria-current="page"{% endif %}>
          {% if breadcrumb.url -%}
          <a href="{{ breadcrumb.url }}" class="text-decoration-none">{{ breadcrumb.text or breadcrumb }}</a>
          {%- else -%}
          {{ breadcrumb.text or breadcrumb }}
          {%- endif %}
        </li>
        {% endfor %}
    </ol>
  </nav>
  <div class="d-flex justify-content-between align-items-start flex-row mt-1 mb-1">
    <div class="btn-toolbar d-none d-md-flex" role="toolbar">
      <a class="btn btn-secondary mr-2" href="{{ url_for('formsview.create_form') }}">{{ _('Create Form') }}</a>
      <a class="btn btn-secondary mr-2" href="#" data-toggle="modal" data-target="#formImportModal">{{ _('Import Form') }}</a>
      <a class="btn btn-primary mr-2" href="#" data-toggle="modal" data-target="#checklistModal">{{ _('Generate Checklists') }}</a>
      <a class="btn btn-success" href="#" data-toggle="modal" data-target="#surveyModal">{{ _('Generate Surveys') }}</a>
    </div>
  </div>
</div>

{% with messages = get_flashed_messages(category_filter=['checklist_init_success']) %}
{% if messages %}
<div class="row">
  <div class="col-md-12">
    <div class="alert alert-success alert-dismissable {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}">
      <button type="button" class="close" data-dismiss="alert" aria-label="{{ _('Close') }}">
        <span aria-hidden="true">&times;</span>
      </button>
      {% for message in messages %}
      <p>{{ message }}</p>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}
{% endwith %}

{% with messages = get_flashed_messages(category_filter=['checklist_init_failure']) %}
{% if messages %}
<div class="row">
  <div class="col-md-12">
    <div class="alert alert-danger alert-dismissable {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}">
      <button type="button" class="close" data-dismiss="alert" aria-label="{{ _('Close') }}">
        <span aria-hidden="true">&times;</span>
      </button>
      {% for message in messages %}
      <p>{{ message }}</p>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}
{% endwith %}

<div class="mb-n3">
  <table class="table table-hover">
    <thead>
      <tr>
        <th scope="col">{{ _('Name') }}</th>
        <th scope="col" class="col-2">{{ _('Type') }}</th>
        <th scope="col" class="col-1">{{ _('Form Actions') }}</th>
      </tr>
    </thead>
    <tbody>
    {% for form in forms %}
      <tr class="{{ 'rtl' if g.locale.text_direction == 'rtl' else '' }}">
        <td>{{ form.name }}</td>
        <td class="align-middle"><span class="badge {% if form.form_type == 'CHECKLIST' %}badge-primary{% elif form.form_type == 'SURVEY' %}badge-success{% else %}badge-secondary{% endif %}">{{ form.get_form_type_display() }}</span></td>
        <td class="align-middle">
          <div class="dropdown">
            <a class="btn btn-primary btn-sm dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              {{ _('Form Actions') }}
            </a>

            <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
              <a class="dropdown-item" href="{{ url_for('formsview.edit_form', form_id=form.id) }}">{{ _('Properties') }}</a>
              <a class="dropdown-item" href="{{ url_for('formsview.builder', form_id=form.id) }}">{{ _('Form Builder') }}</a>
              {% if form.form_type in ['CHECKLIST', 'SURVEY'] and form.quality_checks_enabled -%}
                <a class="dropdown-item" href="{{ url_for('formsview.qc', form_id=form.id) }}">{{ _('Quality Assurance') }}</a>
              {%- endif %}
              <a class="dropdown-item" href="{{ url_for('formsview.form_export', form_id=form.id) }}">{{ _('Export') }}</a>
            </div>
          </div>
        </td>
      </tr>
    {% else %}
      <tr class="table-warning">
        <td colspan="3" class="text-center text-muted">{{ _('No Forms Defined') }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<div id="app">
<form class="form-horizontal" method="POST" action="{{ url_for('formsview.init') }}" id="checklistInitForm">
  <div class="modal fade {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}" id="checklistModal" tabindex="-1" role="dialog" aria-labelledby="checklistModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="checklistModalLabel" class="modal-title">{{ _('Generate Checklists') }}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true" aria-label="{{ _('Close') }}">
            <span aria-hidden="true">&times;</span>
          </button>          
        </div>
        <div class="modal-body">
          <create-checklists-modal-body />
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-modal" data-dismiss="modal" aria-hidden="true">{{ _('Cancel') }}</button>
          <button type="submit" id="send" class="btn btn-primary btn-modal">{{ _('Generate Checklists') }}</button>
        </div>
      </div>
    </div>
  </div>
</form>

<form class="form-horizontal" method="POST" action="{{ url_for('formsview.init_surveys') }}" enctype="multipart/form-data" id="surveyInitForm">
  <div class="modal fade {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}" id="surveyModal" tabindex="-1" role="dialog" aria-labelledby="surveyModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="surveyModalLabel" class="modal-title">{{ _('Generate Surveys') }}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true" aria-label="{{ _('Close') }}">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <create-surveys-modal-body />
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-modal" data-dismiss="modal" aria-hidden="true">{{ _('Cancel') }}</button>
          <button type="submit" id="send" class="btn btn-primary btn-modal">{{ _('Generate Surveys') }}</button>
        </div>
      </div>
    </div>
  </div>
</form>
</div>

<form action="{{ url_for('formsview.import_form') }}" enctype="multipart/form-data" method="post">
  <div class="modal fade {{- ' rtl' if g.locale.text_direction == 'rtl' else '' }}" id="formImportModal" role="dialog" aria-labelledby="formImportModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="formImportModalLabel" class="modal-title">{{ _('Import Form') }}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true" aria-label="{{ _('Close') }}">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {{ form_import_form.hidden_tag() }}
          <div class="custom-file">
            <input type="file" class="custom-file-input upload" id="import_file" name="import_file">
            <label for="import_file" class="custom-file-label" data-browse="{{ _('Browse') }}">{{ _('Choose File') }}</label>
            <small class="form-text text-muted" id="import_file_help_text">{{ _('Only .xls and .xlsx files') }}</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-modal" data-dismiss="modal" aria-hidden="true">{{ _('Cancel') }}</button>
          <button class="btn btn-primary btn-modal">{{ _('Import') }}</button>
        </div>
      </div>
    </div>
  </div>
</form>
{% endblock %}

{%- block tail_js %}
{{ super() }}
<script src="{{ url_for('static', filename='js/vue.min.js') }}"></script>
<script>
  Vue.component('create-checklists-modal-body', {
    template: `
    <div>
      {{ init_form.hidden_tag() }}
      <div class="form-group row align-items-center">
        <label class="col-sm-4 control-label text-right mb-0" for="event">{{ init_form.event.label.text }}</label>
        <div class="col-sm-8">
          <select id="event" class="form-control custom-select" name="event" v-model="event">
            <option value="">{{ _('Choose Event') }}</option>
            <option v-for="event in this.$parent.events" :value="event.id" :key="event.id">{{ '{{' }} event.name {{ '}}' }}</option>
          </select>
        </div>
      </div>
      <div class="form-group row align-items-center">
        <label class="col-sm-4 control-label text-right mb-0" for="form">{{ init_form.form.label.text }}</label>
        <div class="col-sm-8">
          <select id="form" class="form-control custom-select" name="form">
            <option value="">{{ _('Choose Form') }}</option>
            <option v-for="form in forms" :value="form.id" :key="form.id">{{ '{{' }} form.name {{ '}}' }}</option>
          </select>
        </div>
      </div>
      <div class="form-group row align-items-center">
        <label class="col-sm-4 control-label text-right mb-0" for="role">{{ init_form.role.label.text }}</label>
        <div class="col-sm-8">
          <select id="role" class="form-control custom-select" name="role">
            <option value="">{{ _('Choose Role') }}</option>
            <option v-for="role in roles" :value="role.id" :key="role.id">{{ '{{' }} role.name {{ '}}' }}</option>
          </select>
        </div>
      </div>
      <div class="form-group row align-items-center">
        <label class="col-sm-4 control-label text-right mb-0" for="location_type">{{ init_form.location_type.label.text }}</label>
        <div class="col-sm-8">
          <select id="location_type" class="form-control custom-select" name="location_type">
            <option value="">{{ _('Choose Location Type') }}</option>
            <option v-for="location_type in location_types" :value="location_type.id" :key="location_type.id">{{ '{{' }} location_type.name {{ '}}' }}</option>
          </select>
        </div>
      </div>
    </div>
    `,
    data: function() {
      return {
        event: '',
      }
    },
    computed: {
      forms: function() {
        var event = this.event;
        return this.$parent.checklist_forms.filter(function (form) {
          return form.events.indexOf(event) == -1 ? false : true;
        });
      },
      roles: function() {
        var event = this.event;
        return this.$parent.roles.filter(function (role) {
          return role.events.indexOf(event) == -1 ? false : true;
        });
      },
      location_types: function() {
        var event = this.event;
        return this.$parent.location_types.filter(function (location_type) {
          return location_type.events.indexOf(event) == -1 ? false : true;
        });
      },
    }
  });

  Vue.component('create-surveys-modal-body', {
    template: `
    <div>
      {{ init_form.hidden_tag() }}
      <div class="form-group row align-items-center">
        <label class="col-sm-4 control-label text-right mb-0" for="event">{{ init_form.event.label.text }}</label>
        <div class="col-sm-8">
          <select id="event" class="form-control custom-select" name="event" v-model="event">
            <option value="">{{ _('Choose Event') }}</option>
            <option v-for="event in this.$parent.events" :value="event.id" :key="event.id">{{ '{{' }} event.name {{ '}}' }}</option>
          </select>
        </div>
      </div>
      <div class="form-group row align-items-center">
        <label class="col-sm-4 control-label text-right mb-0" for="form">{{ init_form.form.label.text }}</label>
        <div class="col-sm-8">
          <select id="form" class="form-control custom-select" name="form">
            <option value="">{{ _('Choose Form') }}</option>
            <option v-for="form in forms" :value="form.id" :key="form.id">{{ '{{' }} form.name {{ '}}' }}</option>
          </select>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 control-label text-right mb-0 mt-2" for="form">{{ _('Participants') }}</label>
        <div class="col-sm-8">
          <div class="custom-file">
            <input type="file" class="custom-file-input upload" id="import_file" name="import_file">
            <label for="import_file" class="custom-file-label" data-browse="{{ _('Browse') }}">{{ _('Choose File') }}</label>
            <small class="form-text text-muted" id="import_file_help_text">{{ _('Accepts CSV or Excel files with columns for Participant ID (named PARTICIPANT_ID) and Form Serial (named FORM_SERIAL).') }}<br><a href="{{ url_for('static', filename='docs/survey.csv') }}">{{ _('Download Template') }}</a></small>
          </div>
        </div>
      </div>
    </div>
    `,
    data: function() {
      return {
        event: '',
      }
    },
    computed: {
      forms: function() {
        var event = this.event;
        return this.$parent.survey_forms.filter(function (form) {
          return form.events.indexOf(event) == -1 ? false : true;
        });
      },
    }
  });

  var vm = new Vue({
    el: '#app',
    data: {
      events: [{% for event in events %}{id:{{ event.id }}, name:'{{ event.name }}'},{% endfor %}],
      checklist_forms: [{% for form in checklist_forms %}{id:{{ form.id }}, name:'{{ form.name }}', events:[{{ form.events|join(', ', 'id') }}]},{% endfor %}],
      survey_forms: [{% for form in survey_forms %}{id:{{ form.id }}, name:'{{ form.name }}', events:[{{ form.events|join(', ', 'id') }}]},{% endfor %}],
      roles: [{% for role in roles %}{id:{{ role.id }}, name:'{{ role.name }}', events:[{{ role.participant_set.events|join(', ', 'id') }}]},{% endfor %}],
      location_types: [{% for location_type in location_types %}{id:{{ location_type.id }}, name:'{{ location_type.name }}', events:[{{ location_type.location_set.events|join(',', 'id') }}]},{% endfor %}],
    },
  });
</script>
{%- endblock %}
