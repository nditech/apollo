{% extends "core/layout.html" %}
{% load apollo %}{% load comments %}{% load humanize %}{% load static %}
{% block content %}
  {% with submission.siblings as siblings %}
  <form action="" method="post">
    {% csrf_token %}
  <div class="row">
    <div class="span12">
      <table class="table table-bordered">
        <thead>
          {% if submission.form.type == 'CHECKLIST' %}
          <tr>
            <th width="15%">&nbsp;</th>
            <th>1</th>
            {% for sibling in siblings %}
            <th>{{ forloop.counter|add:"1" }}</th>
            {% endfor %}
          </tr>
          {% endif %}
          <tr>
            <th>Observer</th>
            <td><strong>{{ submission.observer.name }}</strong>{% if submission.observer.phone %} ({{ submission.observer.phone }}){% endif %} &mdash; <strong>{{ submission.observer.observer_id }}</strong></td>
            {% if submission.form.type == 'CHECKLIST' %}
            {% for sibling in siblings %}
            <td><strong>{{ sibling.observer.name }}</strong>{% if sibling.observer.phone %} ({{ sibling.observer.phone }}){% endif %} &mdash; <strong>{{ sibling.observer.observer_id }}</strong></td>
            {% endfor %}
            {% endif %}
          </tr>
          <tr>
            <th>Phone</th>
            <td><em>{% if submission.observer.last_connection %}{{ submission.observer.last_connection.identity }}{% else %}{{ submission.observer.phone }}{% endif %}</em>
              {% with submission.observer.phone|slugify as known_number %}{% with submission.observer.last_connection.identity|slugify|default:known_number as texting_number %} <img src="{% if texting_number == known_number %}{% static "img/tick.png" %}{% else %}{% static "img/caution.png" %}{% endif %}" style="vertical-align:text-bottom" />{% endwith %}{% endwith %}</td>
            {% if submission.form.type == 'CHECKLIST' %}
            {% for sibling in siblings %}
            <td><em>{% if sibling.observer.last_connection %}{{ sibling.observer.last_connection.identity }}{% else %}{{ sibling.observer.phone }}{% endif %}</em>
              {% with sibling.observer.phone|slugify as known_number %}{% with sibling.observer.last_connection.identity|slugify|default:known_number as texting_number %} <img src="{% if texting_number == known_number %}{% static "img/tick.png" %}{% else %}{% static "img/caution.png" %}{% endif %}" style="vertical-align:text-bottom" />{% endwith %}{% endwith %}</td>
            {% endfor %}
            {% endif %}
          </tr>
          {% if submission.form.type == 'CHECKLIST' %}
          <tr>
            <th>Location</th>
            <td><strong>{{ submission.location }}</strong></td>
            {% for sibling in siblings %}
            <td><strong>{{ sibling.location }}</strong></td>
            {% endfor %}
          </tr>
          {% if location_types %}
          <tr>
            <th>&nbsp;</th>
            <td>{% for location_type in location_types %}{% get_location_for_type submission location_type "True" %}{% if not forloop.last %} / {% endif %}{% endfor %}</td>
            {% for sibling in siblings %}
            <td>{% for location_type in location_types %}{% get_location_for_type sibling location_type "True" %}{% if not forloop.last %} / {% endif %}{% endfor %}</td>
            {% endfor %}
          </tr>
          {% endif %}
          {% else %}
          <tr>
            <th>Location</th>
            <td>{{ form.location }}</td>
          </tr>
          {% if location_types %}
          <tr>
            <th>&nbsp;</th>
            <td>{% for location_type in location_types %}{% get_location_for_type submission location_type "True" %}{% if not forloop.last %} / {% endif %}{% endfor %}</td>
          </tr>
          {% endif %}
          {% if form.data__location.value %}
          <tr>
            <th>Texted Location</th>
            <td><strong><em>{{ form.data__location.value }}</em></strong>{{ form.data__location }}</td>
          </tr>
          {% endif %}
          {% endif %}
          {% if submission.form.type == 'CHECKLIST' %}
          <tr>
            <th>Supervisor</th>
            <td>{{ submission.observer.supervisor|default_if_none:"" }}</td>
            {% if submission.form.type == 'CHECKLIST' %}
            {% for sibling in siblings %}
            <td>{{ sibling.observer.supervisor|default_if_none:"" }}</td>
            {% endfor %}
            {% endif %}
          </tr>
          {% endif %}
        </thead>
      </table>
      {% if submission.form.type == 'CHECKLIST' %}
      <table class="table table-striped table-bordered table-hover submission-table">
        <tbody>
          <tr>
            <td colspan="2">&nbsp;</td>
            <td style="text-align:center"><strong>1</strong></td>
            {% for sibling in siblings %}
            <td style="text-align:center"><strong>{{ forloop.counter|add:"1" }}</strong></td>
            {% endfor %}
            <td>&nbsp;</td>
          </tr>
          {% for fieldset in form.fieldsets %}
          {% if fieldset.legend %}
          <tr>
            <td colspan="{{ siblings.count|add:"4" }}"><h4 class="{{ fieldset.classes }}">{{ fieldset.legend }}</h4></td>
          </tr>
          {% endif %}
          {% for field in fieldset %}
          <tr{% if field.label in object.overrides %} class="warning"{% endif %}>
            <td>{{ field.label }}</td>
            <td>{{ field.help_text }}
              {% if field.field.choices %}
              <span class="options">
                {% for choice in field.field.choices %}
                <span class="option"><strong>({{ choice.0 }})</strong> {{ choice.1 }}</span>
                {% endfor %}
              </span>
              {% endif %}
            </td>
            <td class="submission-field">{{ submission_form|keyvalue:field.name }}</td>
            {% for sibling in submission_sibling_forms %}
            <td class="submission-field">{{ sibling|keyvalue:field.name }}</td>
            {% endfor %}
            <td class="submission-field">{{ field }}</td>
          </tr>
          {% endfor %}
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <table class="table table-striped table-bordered table-hover">
        <tbody>
          <tr>
            <td colspan="2">&nbsp;</td>
            <td>&nbsp;</td>
          </tr>
          {% for fieldset in form.fieldsets %}
          {% if fieldset.legend %}
          <tr>
            <td colspan="3"><h4 class="{{ fieldset.classes }}">{{ fieldset.legend }}</h4></td>
          </tr>
          {% endif %}
          {% for field in fieldset %}
          <tr{% if field.label in object.overrides %} class="warning"{% endif %}>
            <td style="text-align: center">{{ field.label }}</td>
            <td width="100%"><label for="{{ field.auto_id }}">{{ field.help_text }}
              {% if field.field.choices %}
              <span class="options">
                {% for choice in field.field.choices %}
                <span class="option"><strong>({{ choice.0 }})</strong> {{ choice.1 }}</span>
                {% endfor %}
              </span>
              {% endif %}</label>
            </td>
            <td style="text-align:center">{{ field }}</td>
          </tr>
          {% endfor %}
          {% endfor %}
          <tr>
            <td style="text-align: right">Witness</td>
            <td colspan="2">{{ form.data__witness }}</td>
          </tr>
          <tr>
            <td style="text-align: right">Description</td>
            <td colspan="2">{{ form.data__description }}</td>
          </tr>
          <tr>
            <td style="text-align: right">Status</td>
            <td colspan="2">{{ form.data__status }}</td>
          </tr>
        </tbody>
      </table>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <div class="offset8 span2">
      <button type="submit" class="btn btn-info btn-large btn-block">Save</button>
    </div>
    <div class="span2">
      <a class="btn btn-large btn-block" href="{% url submissions_list object.form.pk %}">Cancel</a>
    </div>
  </div>
  </form>
{% endwith %}

{% if submission.form.type == 'CHECKLIST' %}
<div class="row">
  <div class="span12">
    <table class="table table-striped table-bordered" id="comments">
      {% get_comment_list for submission as comments %}
      {% for comment in comments %}
      <tr>
        <td>
          <p><strong>{{ comment.user_name }}</strong> · <em>{{ comment.submit_date|naturaltime }}</em></p>
          <p>{{ comment.comment }}</p>
        </td>
      </tr>
      {% empty %}
      <tr class="warning">
        <td style="text-align:center">No comment.</td>
      </tr>
      {% endfor %}
      <tr id="save_comment">
        <td>
            <textarea id="comment" style="width:98.5%"></textarea>
            <input type="hidden" id="submission" name="submission" value="{{ submission.pk }}" />
            <input id="save" type="button" value="Add Comment" class="btn btn-primary pull-right" />
            <div id="loader" class="ajax_loader pull-right" style="visibility: hidden">
              <div class="ajax_loader_block block_1"></div>
              <div class="ajax_loader_block block_2"></div>
              <div class="ajax_loader_block block_3"></div>
            </div>
        </td>
      </tr>
    </table>
  </div>
</div>
<script type="text/javascript">
  $('#save').click(function () {
    var comment = $('#comment').val(), submission = $('#submission').val();
    if (comment) {
      $.ajax({
        url: "{% url add_comment %}",
        type: 'POST',
        data: {comment: comment, submission: submission},
        beforeSend: function (xhr) {
          $('#comment').attr('disabled', 'disabled');
          $('#save').attr('disabled', 'disabled');
          $('#loader').attr('style', 'visibility:visible;');
        }
      })
      .done(function (data) {
        // clear the value in the comment box
        $('#comment').val("");
        console.log('Data received:' + data);
        // if there's a table row displaying "No comment.", remove it
        $('#comments tr.warning').remove();
        $('#save_comment').before('<tr><td><p><strong>' + data.username + '</strong> · <em>' + data.date + '</em></p><p>' + data.comment + '</p></td></tr>');
      })
      .always(function () {
        // Re-enable
        $('#comment').removeAttr('disabled');
        $('#save').removeAttr('disabled');
        $('#loader').attr('style', 'visibility:hidden;');
      });  
    }
  });
</script>
{% endif %}
{% endblock %}
